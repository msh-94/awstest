name: Spring Server Deploy   # [필수] GitHub Actions 이름 (가독성용)
on:                         # [필수] 언제 실행할지 정의
  push:                     # [필수] push 이벤트 기반 실행
    branches: [ "STEP6" ]   # [필수] STEP5 브랜치에 push될 때만 실행됨
jobs:                       # [필수] 작업(Job) 집합 정의
  build-and-deploy:         # [필수] Job 이름
    runs-on: ubuntu-latest  # [필수] 실행 OS (GitHub 제공 환경)
    steps:                  # [필수] 단계별 작업 정의
      # 1. Git Source Code Checkout
      - name: Checkout source                   # [필수] 소스코드 가져오기
        uses: actions/checkout@v3               # [필수] GitHub 공식 checkout 액션
      # 2. JDK 설치 (Spring Boot 3.x 기준)
      - name: Set up JDK 17                     # [필수] JDK 17 설치
        uses: actions/setup-java@v4             # [필수] 자바 설정 액션
        with:
          distribution: 'temurin'               # [필수] 자바 배포판 종류
          java-version: '17'                    # [필수] 스프링 부트 3.x 최소버전
          cache: 'gradle'                       # [선택] gradle 캐싱 (빌드 시간 단축)
      # 3. Gradle 권한 부여
      - name: Add permission for gradlew        # [필수] 실행권한 부여
        run: chmod +x ./gradlew                 # [필수] gradlew 실행 허용
      # 4. Build
      - name: Build Spring Boot (bootJar)       # [필수] Spring Boot JAR 빌드
        run: ./gradlew clean bootJar            # [필수] bootJar만 빌드
        shell: bash                             # [필수] bash 쉘 사용
      # 5. 현재 시간으로 버전 이름 생성
      - name: Versioning                        # [선택] 시간 기반 버전 라벨 생성
        uses: 1466587594/get-current-time@v2    # [선택] timestamp 생성 액션
        id: time                                # [필수] Step ID (아래에서 값 참조)
        with:
          format: YYYY-MM-DD-HH-mm-ss           # [선택] 버전 표기 포맷
          utcOffset: "+09:00"                   # [선택] 한국시간
      # 6. 생성된 JAR 파일명 환경변수로 저장
      - name: Set artifact name                 # [필수] 배포할 jar 파일 이름 추출
        run: echo "ARTIFACT=$(basename build/libs/*SNAPSHOT.jar)" >> $GITHUB_ENV
        # [필수] ARTIFACT 환경변수 등록
      # 7. AWS EB 배포
      - name: Deploy to Elastic Beanstalk       # [필수] EB로 배포하는 단계
        uses: einaregilsson/beanstalk-deploy@v21    # [필수] EB 배포 액션
        with:
          aws_access_key: ${{ secrets.ACCESS_KEY_ID }}        # [필수] IAM Key
          aws_secret_key: ${{ secrets.SECRET_ACCESS_KEY }}    # [필수] IAM Secret
          region: ap-northeast-2                                   # [필수] AWS 서울리전
          # 당신 프로젝트 기준 EB 설정
          application_name: springweb-msh           # [필수] EB Application 이름
          environment_name: Springweb-msh-env       # [필수] EB Environment 이름
          version_label: "springweb-${{ steps.time.outputs.formattedTime }}"
          # [선택] 버전 이름 (Timestamp 포함)
          deployment_package: "./build/libs/${{ env.ARTIFACT }}"
          # [필수] 실제 배포할 JAR 파일 경로
          wait_for_environment_recovery: 30     # [선택] 배포 후 안정화 대기 시간
